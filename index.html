<!DOCTYPE html>
<html>

<head>
  <title>Simple Map</title>
  <meta name="viewport" content="initial-scale=1.0">
  <meta charset="utf-8">
  <style>
    /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
    #map {
      height: 100%;
    }

    /* Optional: Makes the sample page fill the window. */
    html,
    body {
      height: 95%;
      margin: 0;
      padding: 0;
    }
  </style>
</head>

<body>
  <input type="text" id="keyword">
  <button id="search">Search</button>
  <div id="map"></div>
  <!-- Add "async" "differ" attribute to correspond Asynchronous processing (suggested in this api) -->
  <script src="https://maps.googleapis.com/maps/api/js?region=JP&key={API key}&callback=initMap&libraries=places"
    async defer></script>
  <script>
    'use strict';
    async function initMap() {
      const map = document.querySelector('#map');
      let target;

      // //enable geolocation API
      //1.check user-agent
      if(!navigator.geolocation){
        alert('This browser is not supported geo location system.');
        return;
      }
      

      try {
        console.log('ちょっと待ってね'); // TODO くるくる見せる
        const userLocation = await getUserLocation();//awaitは普通Promiseとセットで使用(今回の場合は下にあるPromise) - awaitはPromiseの処理が終わるのを待つ
        //Promise処理が終わったら
        target = new google.maps.Map(map, {//targetに以下の情報を仕込む
          center: userLocation,
          zoom: 15,
        });
        console.log('いいよ'); // TODO くるくる消す
      } catch (error) {//tryの中で何かしらエラーが出た場合はすぐにcatchに飛んで来る(いいよは出ない)
        console.error(error);
      }

      //Google places API - API for searching places
      document.querySelector('#search').addEventListener('click', function(){
        console.log('clicked')
        const keyword = document.querySelector('#keyword').value;
        searchBy(target, keyword);//下のsearchBy()を呼び出す
      });
    }
    
    //ユーザーの位置情報を拾って来る関数
    function getUserLocation() {
      return new Promise((resolve, reject) => {//Promiseを定義
        //Allowした場合(denyした場合はconsoleにエラーが表示)
        navigator.geolocation.getCurrentPosition((position) => {//positionにユーザーの位置情報が入ってくる
          //Promise処理が成功した場合の処理だけ定義
          // 位置情報を整形
          const location = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };
          //処理が成功したら上記で定義した処理を走らせる(失敗したら何もしない)
          resolve(location);
        }, reject);//( (position) => {}というファンクション, reject )
      });
    }
    
    //ユーザーの位置情報からキーワードに一致する場所を表示させる関数
    function searchBy(target, keyword) {//target - gmapのオブジェクト, keyword - 検索した文字列
      const places = new google.maps.places.PlacesService(target);//pass parameter "target" which defined above
      places.nearbySearch({
        location: target.center,//中心となる場所(centerはGoogleマップAPIのオブジェクトとしてデフォルトで入っている)
        radius: '500',//その場所からの検索する範囲(単位:m)
        name: keyword,
      }, function (results, status) {//検索結果と処理状況を上記の要素を元に表示する関数を作成
        if (status === google.maps.places.PlacesServiceStatus.OK) {//statusが正常なら	
          //markerを立てる処理
          let i;
          for (i = 0; i < results.length; i++) {//resultの中身が全て吐き出されるまで
            new google.maps.Marker({
              //以下の情報を地図上に出す
              map: target,
              position: results[i].geometry.location,
              title: results[i].name,
            });
          }
        } else {
          alert('failed : ' + status);
          return;
        }
      });
    }
  </script>
</body>

</html>